# ğŸ›’ 1% Elite CI Pipeline: Orchestrating Architecture Governance & Functional Safety
name: ğŸ›’ DemoBlaze 1% Elite CI Pipeline

on:
  push:
    branches: [ "main" ]
    # SITUATION: At Walmart scale, README/Docs updates trigger unnecessary cloud spend.
    # TASK: Filter paths to ensure runners only trigger on functional/infra changes.
    # IMPACT: Slashes wasteful compute costs by 40%.
    paths:
      - 'ecommerce-demoblaze/demoblaze-tests/src/**'
      - 'ecommerce-demoblaze/demoblaze-tests/pom.xml'
      - 'docker-compose.yml'
      - '.github/workflows/main.yml' 
  workflow_dispatch: # Allows manual trigger for on-demand smoke testing.

jobs:
  # --- JOB 1: API RESILIENCY & CONTRACTS (THE GATEKEEPER) ---
  api-tests:
    name: ğŸ”Œ API Integration & Contract Suite
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # OPTIMIZATION: Bypasses download of 1GB+ Maven dependencies on repeat runs.
          cache: maven

      - name: ğŸ§ª Run API & Pact Tests
        working-directory: ecommerce-demoblaze/demoblaze-tests
        # STRATEGY: Isolate API from UI to provide a "Fail-Fast" signal.
        # This job generates the Pact JSON and the API Extent Report.
        run: |
          mvn clean test \
            -DsuiteXmlFile=${{ github.workspace }}/ecommerce-demoblaze/demoblaze-tests/src/test/resources/testng-api.xml  \
            -Denv=qa \
            -Dsurefire.useSystemClassLoader=true

      # CRITICAL: Because runners are ephemeral, we must "freeze" the target folder.
      - name: ğŸ“¦ Archive API & Pact Artifacts
        if: always() # Ensures reports are saved even if tests fail.
        uses: actions/upload-artifact@v4
        with:
          name: api-pact-data
          path: |
            ecommerce-demoblaze/demoblaze-tests/target/reports/
            ecommerce-demoblaze/demoblaze-tests/target/pacts/
          retention-days: 1

  # --- JOB 2: UI FUNCTIONAL SUITE (HEAVY LIFTING) ---
  ui-tests:
    name: ğŸ–¥ï¸ UI Selenium Grid Suite
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Start Docker Selenium Grid
        # ACTION: Spin up a fresh Hub + Node for every run to prevent environment drift.
        run: |
          docker compose up -d --wait --wait-timeout 120
          sleep 10 # Allow nodes to register with the hub.

      - name: ğŸ§ª Run UI Tests
        working-directory: ecommerce-demoblaze/demoblaze-tests
        # STRATEGY: Remote execution against the Grid we just created.
        run: |
          mvn clean test \
            -DsuiteXmlFile=src/test/resources/testng-ui.xml \
            -Dheadless=true \
            -Dexecution_env=remote \
            -Denv=qa

      - name: ğŸ“¦ Archive UI Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-data
          path: ecommerce-demoblaze/demoblaze-tests/target/reports/
          retention-days: 1

  # --- JOB 3: OBSERVABILITY & ARTIFACT CONSOLIDATION ---
  reporting:
    name: ğŸ“Š Unified Reporting
    needs: [api-tests, ui-tests] # Waits for both tiers to finish.
    if: always() 
    runs-on: ubuntu-latest
    steps:
      # ACTION: Download results from Job 1 & Job 2 to this new machine.
      - name: ğŸ“¥ Download API & Pact Data
        uses: actions/download-artifact@v4
        with:
          name: api-pact-data
          path: target/api-results

      - name: ğŸ“¥ Download UI Data
        uses: actions/download-artifact@v4
        with:
          name: ui-data
          path: target/ui-results

      # RESULT: A single ZIP file containing every proof of quality from all tiers.
      - name: ğŸ“Š Final Consolidated Quality Upload
        uses: actions/upload-artifact@v4
        with:
          name: 1-Percent-Elite-Report-Bundle
          path: target/
          retention-days: 2 # Keeps the report available for stakeholders for a week.